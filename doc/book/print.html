<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CloudMon metrics processor</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="convertor.html"><strong aria-hidden="true">1.</strong> Convertor</a></li><li class="chapter-item expanded "><a href="reporter.html"><strong aria-hidden="true">2.</strong> Reporter</a></li><li class="chapter-item expanded "><a href="config.html"><strong aria-hidden="true">3.</strong> Configuration</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CloudMon metrics processor</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cloudmon-metrics"><a class="header" href="#cloudmon-metrics">Cloudmon-metrics</a></h1>
<p>When monitoring cloud it is not unusual to
have a variety of metrics types (latencies,
status codes, rates). Visualizing overall
state of the service based on those metrics
is not an easy task in this case. It is
desired to have something like a semaphore to
visualize overall &quot;health&quot; of the component
(green - up and running, yellow - there are
some issues, red - complete outage).
Depending on the used TSDB there might be no
way to do this at all.</p>
<p>CloudMon-metrics is a there to address 2 primary needs:</p>
<ul>
<li><a href="convertor.html">convertor</a> - convert series of raw metrics of different
types into single semaphore-like metric</li>
<li><a href="reporter.html">reporter</a> - inform status dashboard once certain
component status is not healthy.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cloudmon-metrics-convertor"><a class="header" href="#cloudmon-metrics-convertor">CloudMon metrics convertor</a></h1>
<p>cloudmon-metrics-convertor is a component
that is evaluating health state of the
component based on series of metrics in TSDB.
This is done in few steps.</p>
<h2 id="flag-metrics"><a class="header" href="#flag-metrics">Flag metrics</a></h2>
<p>First step of analysing component health is to process
raw TSDB metrics and convert them to flags (raised,
lowered). For this a component receives configuration
with set of flag metrics with attached TSDB query and
additional logic applied to the query result (i.e.
<code>aggregate(stats.counters.api.*.mean)</code>, <code>gt</code>, <code>1000</code> -
raise a flag once mean value is greater then 1000 ms).</p>
<h2 id="health-metrics"><a class="header" href="#health-metrics">Health metrics</a></h2>
<p>Knowing state of flags tied to the certain aspects of
the component it is possible to evaluate overall
component health state applying boolean logic to the
flags and emit an integer number representing the
resulting state (i.e. <code>api_slow || success_rate_low</code> =&gt;
1; <code>api_down || error_rate_at_100</code> =&gt; 2).</p>
<h2 id="api"><a class="header" href="#api">API</a></h2>
<p>convertor component provides an API that is emiting component health at the requested timeframe according to the configuration.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cloudmon-metrics-reporter"><a class="header" href="#cloudmon-metrics-reporter">CloudMon metrics reporter</a></h1>
<p>cloudmon-metrics-reporter component is a glue layer
between raw metrics and the status dashboard. It runs
an endless loop and at a given interval fetches health
metrics from the convertor component and if the state
is greater then 0 issues an API call towards status
dashboard with the current state of the component.
Status dashboard is then responsible for further
incident processing logic (is it necessary to open an
incident or there is an open incident already).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>All components of the cloudmon-metrics processor are sharing the single configuration file.</p>
<p>Example:</p>
<pre><code>datasource:
  url: https://graphite.example.com
  type: graphite

server:
  address: 192.168.1.14
  port: 3005

metric_templates:
  api_success_rate_low:
    query: &quot;asPercent(sumSeries(stats.counters.openstack.api.$environment.*.$service.*.*.{2*,3*,404}.count), sumSeries(stats.counters.openstack.api.$environment.*.$service.*.*.attempted.count))&quot;
    op: &quot;lt&quot;
    threshold: 90
  api_down:
    query: &quot;asPercent(sumSeries(stats.counters.openstack.api.$environment.*.$service.*.*.failed.count), sumSeries(stats.counters.openstack.api.$environment.*.$service.*.*.attempted.count))&quot;
    op: &quot;eq&quot;
    threshold: 100
  api_slow:
    query: &quot;consolidateBy(aggregate(stats.timers.openstack.api.$environment.*.$service.*.*.*.mean, 'average'), 'avgerage')&quot;
    op: &quot;gt&quot;
    threshold: 300

environments:
  - name: &quot;production&quot;
    attributes:
      region: &quot;Region1&quot;

status_dashboard:
  url: &quot;https://status.cloudmon.com&quot;
  secret: &quot;dev&quot;

flag_metrics:
  ### Comp1
  - name: &quot;api_down&quot;
    service: &quot;comp1&quot;
    template:
      name: &quot;api_down&quot;
    environments:
      - name: &quot;production&quot;
  - name: &quot;api_slow&quot;
    service: &quot;comp1&quot;
    template:
      name: &quot;api_slow&quot;
    environments:
      - name: &quot;production&quot;
  - name: &quot;api_success_rate_low&quot;
    service: &quot;comp1&quot;
    template:
      name: &quot;api_success_rate_low&quot;
    environments:
      - name: &quot;production&quot;

health_metrics:
  ## Compute
  ### DEH
  comp1:
    service: comp1
    component_name: &quot;Component 1 name&quot;
    category: category1
    metrics:
      - comp1.api_down
      - comp1.api_slow
      - comp1.api_success_rate_low
    expressions:
      - expression: &quot;comp1.api_slow || comp1.api_success_rate_low&quot;
        weight: 1
      - expression: &quot;comp1.api_down&quot;
        weight: 2
</code></pre>
<h2 id="datasource"><a class="header" href="#datasource">datasource</a></h2>
<p>datasource section describes url and type of the TSDB that stores the raw metrics</p>
<h2 id="server"><a class="header" href="#server">server</a></h2>
<p>Server section describes address and port to bind to</p>
<h2 id="metric_templates"><a class="header" href="#metric_templates">metric_templates</a></h2>
<p>This section is providing capability to describe query templates to be later referred by the individual flag metrics</p>
<h2 id="status_dashboard"><a class="header" href="#status_dashboard">status_dashboard</a></h2>
<p>Configures URL and jwt secret for communication with the status dashboard</p>
<h2 id="flag_metrics"><a class="header" href="#flag_metrics">flag_metrics</a></h2>
<p>Configures the flag metrics for the components and environments</p>
<h2 id="environments"><a class="header" href="#environments">environments</a></h2>
<p>Configures environment names and optional attributes (used once alerting the status dashboard component)</p>
<h2 id="health_metrics"><a class="header" href="#health_metrics">health_metrics</a></h2>
<p>Configures health metrics for components.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
